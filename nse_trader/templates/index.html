<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSE Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .stock-card {
            transition: transform 0.2s;
        }
        .stock-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .positive {
            color: #4CAF50;
        }
        .negative {
            color: #F44336;
        }
        .analysis-section {
            border-top: 1px solid #eee;
            padding-top: 1rem;
        }
        .recommendation .badge {
            font-size: 0.9rem;
            padding: 0.4rem 0.8rem;
        }
        .price-targets {
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 4px;
            margin: 0.5rem 0;
        }
        .badge-buy {
            background-color: #4CAF50;
        }
        .badge-sell {
            background-color: #F44336;
        }
        .badge-neutral {
            background-color: #ccc;
        }
        .market-summary-card {
            border: none;
            border-radius: 0;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">NSE Tracker</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#market-summary">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#top-stocks">Top Stocks</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#historical-data">Historical Data</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#portfolio">Portfolio</a>
                    </li>
                </ul>
                <form class="d-flex">
                    <input class="form-control me-2" type="search" placeholder="Search stocks..." aria-label="Search">
                    <button class="btn btn-outline-light" type="submit">Search</button>
                </form>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <section id="market-summary" class="mb-5">
            <div class="row">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">NSE All-Share Index</h5>
                            <h3 class="card-text" id="asi-value">54,235.12</h3>
                            <p class="card-text text-success">▲ 1.25%</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Market Capitalization</h5>
                            <h3 class="card-text">₦29.48T</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Trading Volume</h5>
                            <h3 class="card-text">325.6M</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Market Value</h5>
                            <h3 class="card-text">₦5.82B</h3>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="top-stocks" class="mb-5">
            <h2 class="mb-4">Top Stocks</h2>
            <div class="row" id="stock-list">
                <!-- Stock cards will be dynamically inserted here -->
            </div>
        </section>

        <section id="historical-data" class="mb-5">
            <h2 class="mb-4">Historical Data and Trends</h2>
            <canvas id="stock-chart" width="400" height="200"></canvas>
        </section>

        <section id="analysis" class="mb-5">
            <h2 class="mb-4">Analysis</h2>
            <div class="analysis-section">
                <!-- Analysis will be dynamically inserted here -->
            </div>
        </section>

        <div class="mb-4">
            <input type="text" id="stock-search" class="form-control" placeholder="Search for a stock...">
        </div>

        <script>
            const ctx = document.getElementById('stock-chart').getContext('2d');
            let stockChart;

            document.getElementById('stock-search').addEventListener('input', function(event) {
                const symbol = event.target.value.toUpperCase();
                if (symbol) {
                    fetch(`/api/historical/${symbol}`)
                        .then(response => response.json())
                        .then(data => {
                            if (stockChart) {
                                stockChart.destroy();
                            }
                            stockChart = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: data.map(d => d.date),
                                    datasets: [{
                                        label: `${symbol} Price`,
                                        data: data.map(d => d.close),
                                        borderColor: 'rgba(75, 192, 192, 1)',
                                        tension: 0.1
                                    }]
                                },
                                options: {
                                    scales: {
                                        x: {
                                            type: 'time',
                                            time: {
                                                unit: 'day'
                                            }
                                        }
                                    }
                                }
                            });
                        })
                        .catch(error => console.error('Error fetching historical data:', error));
                }
            });
        </script>
    </div>

    <script>
        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('en-NG', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }

        // Fetch market summary
        async function fetchMarketSummary() {
            try {
                const response = await fetch('/api/market-summary');
                const data = await response.json();
                
                document.getElementById('asi-value').textContent = data.asi;
                document.getElementById('asi-change').textContent = data.change_percent;
                document.getElementById('market-cap').textContent = data.market_cap;
                document.getElementById('volume').textContent = data.volume;
                document.getElementById('value').textContent = data.value;
                
                if (data.last_update) {
                    document.getElementById('last-update').textContent = 
                        'Last Update: ' + formatDate(data.last_update);
                }
                
                const asiChange = document.getElementById('asi-change');
                asiChange.className = data.change > 0 ? 'positive' : 'negative';
            } catch (error) {
                console.error('Error fetching market summary:', error);
            }
        }

        // Fetch stocks
        async function fetchStocks() {
            try {
                const response = await fetch('/api/stocks/top');
                const stocks = await response.json();
                
                const stockList = document.getElementById('stock-list');
                stockList.innerHTML = stocks.map(stock => `
                    <div class="col-md-4 mb-4">
                        <div class="card stock-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h5 class="card-title mb-0">${stock.symbol}</h5>
                                        <h6 class="card-subtitle text-muted">${stock.name}</h6>
                                    </div>
                                    <span class="badge ${getRecommendationClass(stock.recommendation)}">
                                        ${stock.recommendation || 'NO DATA'}
                                    </span>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <p class="card-text mb-0 h4">${stock.price}</p>
                                        <p class="card-text ${stock.change > 0 ? 'positive' : 'negative'} mb-0">
                                            ${stock.change_percent}
                                        </p>
                                    </div>
                                    <div class="text-end">
                                        <div class="text-muted small">Market Cap</div>
                                        <div class="fw-bold">${stock.market_cap}</div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col">
                                        <div class="text-muted small">Volume</div>
                                        <div>${stock.volume}</div>
                                    </div>
                                    <div class="col text-end">
                                        <div class="text-muted small">Value</div>
                                        <div>${stock.value}</div>
                                    </div>
                                </div>
                                
                                <div class="trading-info">
                                    <div class="d-flex justify-content-between mb-2">
                                        <small class="text-muted">Open</small>
                                        <span>${stock.open}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <small class="text-muted">High</small>
                                        <span>${stock.high}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-3">
                                        <small class="text-muted">Low</small>
                                        <span>${stock.low}</span>
                                    </div>
                                    
                                    <div class="alert ${getRecommendationAlertClass(stock.recommendation)} py-2 px-3 mb-0">
                                        <small class="d-block"><strong>Signal:</strong> ${stock.explanation}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error fetching stocks:', error);
            }
        }

        // Helper function to get recommendation badge class
        function getRecommendationClass(recommendation) {
            switch (recommendation?.toUpperCase()) {
                case 'STRONG_BUY':
                case 'BUY': return 'badge-buy';
                case 'STRONG_SELL':
                case 'SELL': return 'badge-sell';
                default: return 'badge-neutral';
            }
        }

        // Helper function to get recommendation alert class
        function getRecommendationAlertClass(recommendation) {
            switch (recommendation?.toUpperCase()) {
                case 'STRONG_BUY':
                case 'BUY': return 'alert-success';
                case 'STRONG_SELL':
                case 'SELL': return 'alert-danger';
                default: return 'alert-secondary';
            }
        }

        // Update data every minute
        function startDataUpdates() {
            fetchMarketSummary();
            fetchStocks();
            setInterval(() => {
                fetchMarketSummary();
                fetchStocks();
            }, 60000);
        }

        // Start updates when page loads
        document.addEventListener('DOMContentLoaded', startDataUpdates);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
